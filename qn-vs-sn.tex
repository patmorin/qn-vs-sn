\documentclass{patmorin}
\listfiles
\usepackage{pat}
\usepackage{paralist}
\usepackage{dsfont}  % for \mathds{A}
\usepackage[utf8x]{inputenc}
\usepackage{skull}
\usepackage{paralist}
\usepackage{graphicx}
\usepackage[noend]{algorithmic}

\usepackage[normalem]{ulem}
\usepackage{cancel}
\usepackage{enumitem}

\usepackage{todonotes}

\usepackage[longnamesfirst,numbers,sort&compress]{natbib}

\usepackage[mathlines]{lineno}
\setlength{\linenumbersep}{2em}
% \linenumbers
% \rightlinenumbers
% \linenumbers
\newcommand*\patchAmsMathEnvironmentForLineno[1]{%
 \expandafter\let\csname old#1\expandafter\endcsname\csname #1\endcsname
 \expandafter\let\csname oldend#1\expandafter\endcsname\csname end#1\endcsname
 \renewenvironment{#1}%
    {\linenomath\csname old#1\endcsname}%
    {\csname oldend#1\endcsname\endlinenomath}}%
\newcommand*\patchBothAmsMathEnvironmentsForLineno[1]{%
 \patchAmsMathEnvironmentForLineno{#1}%
 \patchAmsMathEnvironmentForLineno{#1*}}%
\AtBeginDocument{%
\patchBothAmsMathEnvironmentsForLineno{equation}%
\patchBothAmsMathEnvironmentsForLineno{align}%
\patchBothAmsMathEnvironmentsForLineno{flalign}%
\patchBothAmsMathEnvironmentsForLineno{alignat}%
\patchBothAmsMathEnvironmentsForLineno{gather}%
\patchBothAmsMathEnvironmentsForLineno{multline}%
}


\newcommand{\coloured}[2]{{\color{#1}{#2}}}
\newenvironment{colourblock}[1]{\color{#1}}{}

\newcommand{\condref}[1]{(C\ref{#1})}

% Taken from
% https://tex.stackexchange.com/questions/42726/align-but-show-one-equation-number-at-the-end
\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}}


\setlength{\parskip}{1ex}


\DeclareMathOperator{\diam}{diam}
\DeclareMathOperator{\tw}{tw}
\DeclareMathOperator{\gm}{gm}
\DeclareMathOperator{\gs}{gs}
\DeclareMathOperator{\qn}{qn}
\DeclareMathOperator{\sn}{sn}
\DeclareMathOperator{\stw}{stw}
\DeclareMathOperator{\ltw}{ltw}
\DeclareMathOperator{\pw}{pw}
\DeclareMathOperator{\lpw}{lpw}
\DeclareMathOperator{\lhptw}{lhp-tw}
\DeclareMathOperator{\lhppw}{lhp-pw}

\DeclareMathOperator{\x}{x}
\DeclareMathOperator{\depth}{d}
\DeclareMathOperator{\sh}{cbt}
\DeclareMathOperator{\cbt}{cbt}
\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\dc}{dc}
\DeclareMathOperator{\afci}{\overline{\chi}_\pi}
\DeclareMathOperator{\afcn}{\dot{\chi}_\pi}

\newcommand{\ellt}{{\lfloor\ell/2\rfloor}}

\title{\MakeUppercase{Queue number is not bounded by stack number}\thanks{This research was partly funded by NSERC.}}
\author{Pat Morin%
    \thanks{School of Computer Science, Carleton University}}

\date{}

\DeclareMathOperator{\ddiv}{div}
\DeclareMathOperator{\hist}{h}

\newcommand{\colored}[2]{{\color{#1}#2}}

\usepackage{tabularx}

\DeclareMathOperator{\ci}{\overline{\pi}}

\begin{document}

% \begin{titlepage}
\maketitle

\begin{abstract}
    We describe a family $\mathcal{G}$ of graphs such that every graph in $\mathcal{G}$ has stack number at most $X$ but for every integer $k$, there exists a graph in $\mathcal{G}$ whose queue number is greater than $k$.  This resolves a problem posed by Heath, Leighton, and Rosenberg in 1992.
\end{abstract}
% \end{titlepage}

% \pagenumbering{roman}
% \tableofcontents
%
% \newpage
% \pagenumbering{arabic}



\section{Introduction}



\section{Routing Through Expanders}
\label{expander_construction}

Let $d$ and $n$, be positive integers, $n$ a multiple of $4$, and let $\epsilon>0$. A  \emph{$d$-monotone $\epsilon$-expander of order $n$} is a bipartite graph $G$ with vertex set $V(G):=\{1,\ldots,2n\}$ and parts $A:=\{1,\ldots,n\}$ and $B:=\{n+1,\ldots,2n\}$ with the following properties:
\begin{compactenum}[(i)]
  \item ($d$-monotone): The edges of $G$ can be partitioned into $d$ $M_1,\ldots,M_d$ such that, for any $i\in\{1,\ldots,d\}$ and any two edges $vw,xy\in M_i$, with $v,x\in A$ and $w,y\in B$, $v < x$ if and only if $w < y$.
  \item ($\epsilon$-expander): For any $S\subseteq\{1,\ldots,n\}$ with $|S|\le 3n/4$, $|N_G(S)|\ge (1+\epsilon)|S|$.
\end{compactenum}

Property~(ii) implies the following property that we will make use of.
\begin{compactenum}[(i)]\setcounter{enumi}{2}
  \item (non-shrinking): For any $S\subseteq\{1,\ldots,n\}$ with $|S|\ge 3n/4+1$, $|N_G(S)|\ge 3n/4+1$.
\end{compactenum}
To see why Property~(iii) follows from Property~(ii), observe that if $S$ is a counterexample to Property~(iii) then any $(3n/4)$-element subset $S'\subseteq S$ has $|N_G(S')|\le |N_G(S)| \le 3n/4 < (1+\epsilon)|S'|$, thereby contradicting Property~(ii).  We will make use of the following result of \cite{bourgain:X,bourgain.yehudahoff:X} (see also \citet{XX} for additional discussion.)

\begin{thm}[Bourgain]\label{bourgain}
    There exists absolute constants $\epsilon>0$ and $d>0$ such that for any $n\in\N$ there exists a  $d$-monotone $\epsilon$-expander of order $n$.
\end{thm}

Using \cref{bourgain}, we construct the following $(2r+1)n$-vertex graph $X_{n,r}$:
\begin{itemize}
  \item The vertices of $X$ are partitioned into $2r+1$ $n$-element sets $V_0,\ldots,V_{2r}$ and we let $\{v_{i,j}:j\in\{1,\ldots,n\}$ denote the elements of $v_i$.

  \item for each $i\in\{1,\ldots,r\}$, the induced subgraph $X[V_{i-1}\cup V_i]$ is isomorphic to an $d$-monotone $\epsilon$-expander of order $n$, using the mapping that takes $v_{i-1,j}\mapsto j$ and $v_{i,j}\mapsto n+j$ for each $j\in\{1,\ldots,n\}$.

  \item for each $i\in\{r,\ldots,2r-1\}$, the induced subgraph $X[V_{i+1}\cup V_i]$ is isomorphic to an $d$-monotone $\epsilon$-expander of order $n$, using the mapping that takes $v_{i+1,j}\mapsto j$ and $v_{i,j}\mapsto n+j$ for each $j\in\{1,\ldots,n\}$.
\end{itemize}

\begin{lem}\label{expansion}
  Let $\epsilon$ and $d$ be the values whose existence is the subject of \cref{bourgain}.  Let $k, x, r, n$ be positive integers such that $k\le n$, and $x\le \epsilon k/(2+\epsilon)\le n/4$.  Let $\overline{V}$ be a subset of $V(X_{n,r})$ such that $|\overline{V}\cap V_i|\le x$ for each $i\in\{0,\ldots,2r\}$ and let $S$ be a $k$-element subset of $V_0$.

  Then, for each $i\in\{0,\ldots,r\}$, there exists a subset $S_i'\subseteq V_i\setminus\overline{V}$ of size $|S_i'|\ge \min\{n/2+1,(1+\epsilon/2)^i (k-x)\}$ such that $X_{n,r}-\overline{V}$ contains a length-$i$ path from each $v\in V_i'$ to some vertex in $S\setminus\overline{V}$.
\end{lem}

\begin{proof}
  \todo{Clean this up}
  Let $S_0':= S\setminus\overline{V}$ and observe that $|S_0'|\ge |S|-x$.  For each $i\in\{1,\ldots,r\}$, define
  $S_i':=N_X(S_{i-1}')\cap V_i\setminus \overline{V}$.
  Observe that, for each $v\in S_i'$, $X_{n,r}-\overline{V}$ contains a length-$i$ path $P_v$ from $v$ to some vertex in $S_0'=S_{\ell}$.  We claim that, for each $i\in\{0,\ldots,r\}$,
  $|S_i'|\ge \min\{n/2+1,(1+\epsilon/2)^i(k-x)\}$
  and prove this claim by induction on $i$.  In the base case $i=0$, and the statement is easily verified since $|S_0'|=|S\setminus\overline{V}|\le k-x$

  % \ell\ge (1-\beta)k=(1+\epsilon/2)^0(1-\beta)k$.

  Now suppose $i\in\{1,\ldots,r\}$.  If $|V_{i-1}'|\ge 3n/4+1$ then $|S_i'|\ge |V_{i-1}|-k\ge 3n/4-\ell+1$ and we are done.  Otherwise, $|V_{i-1}'|\le 3n/4$ and, since the graph $X[V_{i-1}\cup V_i]$ is isomorphic to an $\epsilon$-expander,  $|N_X(S_{i-1}')\cap V_i| \ge (1+\epsilon)|S_{i-1}'|\ge (1+\epsilon)(1+\epsilon/2)^{i-1}(1-\beta)k$.  Furthermore,
  \begin{align*}
    |S_i'| & = |N_X(S_{i-1'})\cap V_i\setminus \overline{V}| \\
      & \ge |N_X(S_{i-1}')\cap V_i|-(\ell-1) \\
      & \ge (1+\epsilon)(1+\epsilon/2)^{i-1}(1-\beta)k-\beta k \\
      & = (1+\epsilon/2)^i(1-\beta)k + (\epsilon/2)(1+\epsilon/2)^{i-1}(1-\beta) k - \beta k \\
      & \ge (1+\epsilon/2)^i(1-\beta)k + (\epsilon/2)(1-\beta) k - \beta k
       & \text{(since $i\ge 1$)} \\
      & = (1+\epsilon/2)^ik \enspace .
  \end{align*}
  This implies that
  \[
    |S_r'|\ge \min\{3n/4-\ell+1,(1+\epsilon/2)^rk\} = \min\{3n/4-\ell+1,n\} = 3n/4-\ell+1
  \]
  since $r\ge \log(n/k)/\log(1+\epsilon/2)$.
\end{proof}

\begin{lem}\label{menger}
  Let $\epsilon, d, k, x, r, n$ and $\overline{V}$ be as in \cref{expansion} with the additional restriction that $r\ge\log(n/k)/\log(1+\epsilon/2)$. Let $S\subseteq V_0$ and $T\subseteq V_{2r}$ each be $k$-element sets.  Then $X_{n,r}-\overline{V}$ contains a path $P$ of length $2r$ and with one endpoint in $V_0$ and one endpoint in $V_{2r}$.
\end{lem}

\begin{proof}
  With the additional condition on $r$,
  applying \cref{expansion} yields a set $S'_r\subseteq V_{r}$ of size at least $n/2+1$.  Using the symmetry between $S\subseteq V_0$ and $T\subseteq V_{2r}$, a symmetric application of \cref{expansion} gives a set $T'_r\subseteq V_{r}$ of size at least $n/2+1$.  Since $|V_r|=n$,  there exists some $v\in S'_r\cap T'_r$ such that $X_{n,r}-\overline{V}$ contains a path of length $r$ from some $u\in S\setminus X$ to $v$ and contains a path of length $r$ from $v$ to some $w\in T\setminus X$.  The concatenation of these two paths gives the desired path.
\end{proof}

\begin{lem}\label{large_flow}
  Let $\epsilon, d, k, r, n$ be as in \cref{menger} and let $S\subseteq V_0$ and $T\subseteq V_{2r}$ each be $k$-element sets.  Then $X_{n,r}$ contains $t:= \lfloor \epsilon k / (2+\epsilon)\rfloor$ vertex-disjoint paths $P_1,\ldots,P_{t}$ each of length $2r$ and each having an endpoint in $S$ and an endpoint in $T$.
\end{lem}

\begin{proof}
  For each $\ell:=1,\ldots,t$ apply \cref{menger} with $\overline{V}:=\bigcup_{a=1}^{\ell-1} V(P_a)$ to find a path $P_\ell$ that is vertex-disjoint from $P_{1},\ldots,P_{\ell-1}$.  This works because $|\overline{V}\cap V_i|\le t$ which satisfies the requirements placed on $x:=t$ in the application of \cref{meet_in_middle}.
\end{proof}

\begin{lem}\label{large_crossing_flow}
  Let $\epsilon, d, k, r, n$ be as in \cref{menger} and such that $p:=n/k$ is an integer and $p\le \epsilon k/(2+\epsilon)$. Let $S_1,\ldots,S_p\subseteq V_0$ and $T_1\ldots,T_p\subseteq V_{2r}$ each be $k$-element sets.  Then there exists $p$ vertex-disjoint paths $P_1,\ldots,P_{p}$ each of length $2r$ such that, for each $\ell\in\{1,\ldots,p\}$, $P_i$ has an endpoint in each of $S_i$ and $T_i$.
\end{lem}

\begin{proof}
  The proof is the same as that of \cref{large_flow} except that we now use the fact that $p\le \epsilon k/(2+\epsilon)$.
\end{proof}


\begin{lem}\label{large_ordered_flow}
  Let $\epsilon, d, k, r, n$ be as in \cref{menger} and let $S\subseteq V_0$ and $T\subseteq V_{2r}$ each be $k$-element sets.  Then there exists $t:= \lfloor \epsilon k / (2+\epsilon)d^{2r}\rfloor$ vertex-disjoint paths $P_1,\ldots,P_{t}$, where, for each $\ell\in\{1,\ldots,t\}$, $P_\ell$ has endpoints $v_{0,a_\ell}$ and ends at $v_{2r,b_\ell}$ and, for each $\ell,\ell'\in\{1,\ldots,t\}$, $a_\ell < a_{\ell'}$ if and only if $b_\ell < b_\ell'$.
\end{lem}

\begin{proof}
  Apply \cref{menger} and then partition the resulting set of paths into $d^{2r}$ sets, each of which is \emph{non-crossing}.  The largest of these subsets gives the result.
\end{proof}


\section{The Counterexample Graph}

Define the graph $Q_n$ as follows:

\begin{enumerate}
  \item $Q_{n,r}$ contains the graph $X_{n,r}$ defined in  \cref{expander_construction}, for a value $r$ to be defined later.
  \item $Q_{n,r}$ contains an additional set $Y:=\{y_1,\ldots,y_n\}$ of $n$ vertices.
  \item For each $i\in\{1,\ldots,n\}$, $Q_{n,r}$ contains the path $v_{0,i}y_iv_{2r,i}$.
\end{enumerate}


\begin{clm}
  For any integers $n$ and $r$, $\sn(Q_{n,r}) \le 2d$.
\end{clm}

\begin{proof}
  To obtain a $2d$ stack layout of $Q_n$, use the following total order:
  \begin{compactenum}
    \item $V_0 < V_1 <\cdots <V_r < Y$.
    \item $y_n < y_{n-1}<\cdots < y_1$.
    \item For even $i\in\{0,\ldots,2r\}$, $v_{i,0} < v_{i,1} < \cdots v_{i,n}$.
    \item For odd $i\in\{1,\ldots,2r-1\}$, $v_{i,n}< v_{i,n-1} < \cdots v_{i,1}$.
  \end{compactenum}
  It is easy to verify that this produces a $2d$ stack layout.\todo{Draw picture and explain stack assignment.}
\end{proof}


\begin{lem}\label{rainbow_alternative}
    Let $M$ be a perfect matching with edge set $E(M):=\{s_it_i:i\in\{1,\ldots,n\}\}$ and let $<$ be a total order on $V(M)$.  Then
    \begin{compactenum}[(i)]
        \item $M$ contains a rainbow of size at least $q$ or
        \item there exists $I\subset\{1,\ldots,n\}$, $|I|\ge k/(2q)$ such that $s_i < s_j$ if and only if $t_i< t_j$ for each $i,j\in I$.
    \end{compactenum}
\end{lem}

\begin{proof}
    Partition the edges of $M$ into two classes, those for which $a_i<b_i$ and those for which $a_i>b_i$.  Assume, without loss of generality that the first class has size at least $|M|/2$.  Next apply Dilworth's Theorem to the partial order $(\prec,\{1,\ldots,k\})$ in which $i\prec j$ if and only if $a_i<a_j$ and $b_i < b_j$.  Any antichain in $\prec$ is a rainbow and any chain in $\prec$ is the set $I$ in the second alternative.
\end{proof}

\begin{lem}\label{rainbow_alternative_paths}
    Let $G$ be a graph consisting of $n$ vertex-disjoint paths $P_1,\ldots,P_n$, each of length $\ell$ and with $P_i$ beginning at $s_i$ and ending at $t_i$, for each $i\in\{1,\ldots,k\}$.  Then, for any $q$-queue layout $(<,\varphi)$ of $G$, there exists $J\subseteq\{1,\ldots,n\}$, $|J|\ge n/(2q)^\ell$ such that $s_i<s_j$ if and only if $t_i<t_j$ for each $i,j\in J$.
\end{lem}

\begin{proof}
    The proof is by induction on $\ell$.  If $\ell=0$, then $s_i=t_i$ for each $i\in\{1,\ldots,n\}$ and the result is trivially true, by taking $J:=\{1,\ldots,n\}$.

    If $\ell\ge 1$, then apply \cref{rainbow_alternative} to the matching $M$ with edge set $E(M):=\{s_is_i':i\in\{1,\ldots,k\}\}$, where $s_i'$ denotes the second vertex in $P_i$.  The fact that $(<,\varphi)$ is a $q$-queue layout rules out alternative \cref{rainbow_alternative}(i).  Therefore, let $I$, $|I|\ge k/(2q)$, be the set determined by \cref{rainbow_alternative}(ii).  For each $i\in I$, let $P'_i$ be the path obtained by removing $s_i$ from $P_i$ (so that $P_i'$ begins at $s_i'$ and ends at $t_i$).  Now apply the inductive hypothesis to the set of paths $\{P_i':i\in I\}$.  This gives a set $J\subseteq I$ of size $|J|\ge |I|/(2q)^{\ell-1}\ge n/(2q)^\ell$ for which $s_i' < s_j'$ if and only if $t_i < t_j$ for each $i,j\in J$.  By \cref{rainbow_alternative}(ii), $a_i < a_j$ if and only if $a_i' < a_j'$, for each $i,j\in I$.  By transitivity, for each $i\in K$, $s_i < s_j$ if and only if $t_i< t_j$, as required.
\end{proof}


\todo[inline]{We are still missing an ingredient to make all of this work.  We need to construct some auxilliary graph on $v_{0,1},\ldots,v_{0,n}$ that places some restrictions on the ordering of $v_{0,1},\ldots,v_{0,n}$.  Keep reading.}

In particular, it would be enough to find a graph that guarantees a sequence $i_1<\cdots<i_s$ of length $s\ge  n^\epsilon$ (\emph{long}) with $i_s-i_1 \le n^{\epsilon+o(1)}$ (\emph{dense}) such that $v_{0,i_1}<\cdots<v_{0,i_s}$ or $v_{0,i_1}>\cdots>v_{0,i_s}$ (\emph{monotone}). Then, by attaching separate copies of $Q_{n^{\epsilon},r}$ (for appropriately chosen $r$) to consecutive vertices we could then prove the existence of a big rainbow using \cref{large_ordered_flow}. Even if we can't guarantee this, it would be enough to guarantee it at some ``scale'' (where we divide indices by $2^p$ for some $p\in \{0,\ldots,\log n- O(\log\log n)\}$.

One strategy I was thinking of was to attach a perfectly balanced binary tree with $v_{0,1},\ldots,v_{0,n}$ at its leaves. In this case, one can show that the number orderings that yield at $q$-queue layout is at most $O(q)^n=2^{O(n\log q)}$, which is much less than $n!=2^{O(n\log n)}$, so this greatly restricts the number of possible orderings.\footnote{Prove this by induction on the height of the binary tree.  Once the ordering of level $h-1$ is fixed, ordering level $h$ involves a rainbow matching with the right children of their parents $(2q)^{n/2}$, a rainbow matching with the left children of their parents $(2q)^{n/2}$, and $4q$-way merging of the resulting sequences, not more than $(4q)^n$.  This leads to a product of the form $\prod_{i=0}^{\log_2 n} 2^{O(2^i\log q)}=2^{O(n)\log q}$.}  That, by itself isn't quite enough because it allows for the recursive layout obtained by expanding the sequence $1032$.  This layout, which can be visualized using the program \verb+bad.py+ has no monotone subsequence of length $\omega(\sqrt{n})$ and this is also true if one considers any consecutive $k$-element subset of the indices (such such a subset has a longest monotone subsequence of length $O(\sqrt{k})$).

To foil this layout, we could also put a ``rainbow hypercube'' on $v_{0,1},\ldots,v_{0,n}$, so that the recursive layout would create a rainbow of size $n/4$ unless we (say) reverse groups $1$ and $3$.  Denote this by $\overline{1}0\overline{3}2$.  This is a valid layout whose maximum rainbow size is $O(\log n)$, which is also the stack number of the rainbow hypercube, so this works.  But this only works by accident because the binary tree and rainbow hypercube match up so nicely, (there are no edges between groups $0$ and $2$ and no edges between groups $1$ and $3$).

To foil that, I was thinking of using an Alon-Roichman expander (bipartite or with the halves merged, possibly even a hypercube-style hierarchy of bipartite expanders), which seems very unlikely to allow that kind of layout.  In fact, even forgetting about the binary tree, it seems like any $q$-queue layout of a bipartite Alon-Roichman expander with parts $x_1,\ldots,x_{n/2}$ and $y_{n/2},\ldots,y_{1}$ must have a long dense monotone sequence.   The main intuition behind this would be to suppose that $x_1,\ldots,x_{n/2}$ contain no long dense monotone subsequence.  This means that $x_1,\ldots,x_{n/2}$ has a very fancy ordering and (by including each edge $x_iy_{n/2-i+1}$) $y_{n/2},\ldots,y_{1}$ must also kind of respect this ordering.  (It comes from a set of $2^{O(n\log q)}$ possible orderings.)  But the Alon-Roichman expander contains many matchings, so there are $O(\log n)$ values of $s$ such that $y_{n/2-s},\ldots,y_{1-s}$ must also kind of respect that ordering.   Somehow, in a way that I haven't yet figured out, this seems to only be possible if the ordering has long dense monotone sequences.

The most obvious ordering that works is $x_1<\cdots<x_{n/2}$, but others are possible. The standard example showing the tightness of Erd\H{o}s-Szekeres also works.  Anything that involves splitting into blocks of roughly equal length and reversing all blocks also works.  And, of course, anything that involves a few rounds of arbitrary $2$-colouring and then splitting the order based on colours also works.  But these all lead to long dense increasing sequences.  (For example, using blocks of size $n^{o(1)}$ leaves the obvious sequence.  Using blocks of size $n^{\Omega(1)})$ does too.


% \begin{clm}
%   For infinitely many values of $n$, $\qn(Q_{n,r})\ge f(n)$.
% \end{clm}
%
% \begin{proof}
%   Suppose, for the sake of contradiction, that $\qn(Q_{n,r}) \le q$ for all $n,r\in \N$ and (by rounding up, if necessary) that $q=2^a$ is a power of $2$.
%
%   We will begin by choosing $n$, $k$, and $p$ that are compatible with \cref{x_graph}.  Let $x$ be a positive integer whose value will be lower bounded later.  Let $n:=2^{x^2}$, let $p:=2^x$, let $k=n/q^2p=2^{x^2-x-2a}$,
%   and let $r:=\lceil(x+2a)/\log(1+\epsilon)\rceil$.
%
%
%
%   For all sufficiently large $x$,
%   \[
%     \epsilon k/2 = \epsilon 2^{x^2-x-2a-1} \ge 2^x = p \enspace .
%   \]
%   Next,
%   \[
%     kp = 2^{x^2-2a} \le 2^{x^2} = n \enspace .
%   \]
%   Finally,
%   \[
%     r = \left\lceil \frac{x+2a}{\log(1+\epsilon)}\right\rceil \ge \frac{x+2a}{\log(1+\epsilon)} = \frac{\log(n/k)}{\log(1+\epsilon)} \enspace .
%   \]
%   Thus, for all sufficiently large $x$, $n$, $k$, and $p$ satisfy the conditions of \cref{x_graph}.  Finally, for sufficiently large $x$,
%   \[
%     (2q)^{2r} = 2^{(a+1)\left\lceil\frac{x+2a}{\log(1+\epsilon)}\right\rceil}
%     <? 2^{x}
%   \]
%
%
%
%
%
%   Take $n$ be a power of $2$ such that $\sqrt{\log n}$ is an integer and $n\ge q^2 p$, where $p=2^{\sqrt{\log n}}$.  Then $k:=n/q^{2}p$ is also an integer since both the numerator and denominator are powers of $2$ and the numerator is not smaller than the denominator.
%
%
%   Choose any $n$ such that $p:=2^{\sqrt{\log n}}$ is an integer.
%
%   Let $(<,\varphi)$ be a $q$-queue layout of $Q_{n,r}$.
%   Apply \cref{rainbow_alternative_paths} to the set of paths $\{v_{0,i}y_iv_{2r,i}:i\in\{1,\ldots,n\}\}$ to obtain $\{i_1,\ldots,i_{kp}\}\subseteq\{1,\ldots,n\}$, with $k\ge n/q^2$ and labelled so that $x_{0,i_1}<x_{0,i_2}<\cdots<x_{0,i_k}$ (and therefore $x_{2r,i_1}<x_{2r,i_2}<\cdots<x_{2r,i_k}$).
%
%
% \end{proof}
%
%
%





















\end{document}

A lemma of \citet{dujmovic.wood:stacks} states that, if queue-number is bounded by stack-number, then queue-number is bounded by a polynomial function of stack number. More precisely, if there exists a function $f:\N\to\N$ such that $\qn(G)\le f(\sn(G))$ for all graphs $G$ then there exists a constant $c$ such that $\qn(G)\in O((\sn(G))^c)$ for all graphs $G$.


Here is a blocked variant of the Erd\H{o}s-Szekeres Theorem that may or may not be true:
\begin{lem}\label{block_erdos_szekeres}
    Let $n:=cr^2$ for some integers $r$ and $c$ and let $\pi_1,\ldots,\pi_n$ be a permutation of $\{1,\ldots,n\}$.  Then there exists integers $1\le k_1<k_2<\cdots<k_r\le cr$ and  $i_1<i_2<\cdots< i_r$ such that
    \begin{compactenum}[(i)]
        \item $i_x\in \{(k_x-1)r+1,\ldots,k_xr\}$ for each $x\in\{1,\ldots,r\}$ and
        \item $\pi_{i_1}<\pi_{i_2}<\cdots<\pi_{i_r}$ or  $\pi_{i_1}>\pi_{i_2}>\cdots>\pi_{i_r}$
    \end{compactenum}
\end{lem}

\textbf{Update:} It's not true, not even close.  A bad example can be created by starting with the sequence $s_1:=\langle 1,0,3,2\rangle$ and then repeatedly using the substitution that replaces $x$ with $4x+1, 4x, 4x+3, 4x+2$.  This gives a self-similar looking sequence that, if you look at any level of granularity, and take any consecutive subsequence of length $k$, you will only find a monotone subsequence of length $O(\sqrt{k})$. The are other variations as well. See the program \texttt{bad.py} for examples and a visualization.

Let $Q_d$ be the \emph{$d$-cube}, the graph with vertex set $V(Q_d):=\{0,\ldots,2^d-1\}$ and that contains the edge $xy$ if and only if the binary representation of $x$ and $y$ differ in exactly one bit.  For two graphs $G$ and $H$, the \emph{direct product} $G\times H$ is the graph whose vertex set is the cartesian product $V(G\times H):=V(G)\times V(H)$ and whose edge set and edge with endpoints $(x_1,y_1)$ and $(x_2,y_2)$ if and only if $x_1x_2\in E(G)$ and $y_1y_2\in E(H)$.

\begin{lem}\label{routing}
    Let $d>0$ be an integer, let $n:=2^d$, let $1 \le m\le n$.
    Then there exists $r:=r(n,m)\le \log(n/m)+O(\sqrt{d})$ such that the following is true:  Let $P:=p_0,\ldots,p_r$ be a path and let $R:=R(n,m)$ be the supergraph of $Q_d\times P_r$ that also contains the edges of the path $(x,p_0),\ldots,(x,p_r)$ for each $x\in V(Q_d)$.  Let $S$ be an $m$-element subsets of $V(Q_d)$ and let $T:=\{n-v-1:v\in S\}$.   Then $R$ contains $s\ge m/(2n/m)^{O(\sqrt{d})}$ vertex-disjoint length-$r$ paths $P_1,\ldots,P_s$ such that,
    \begin{compactenum}
        \item for each $i\in\{1,\ldots,s\}$, $P_i$ begins at $(s_i,p_0)$ for some $s_i\in S$ and ends at $(t_i,p_r)$ some $t_i\in T$ and
        \item for each $i,j\in\{1,\ldots,s\}$, $s_i < s_j$ if and only if $t_i < t_j$.
    \end{compactenum}
\end{lem}

[Note that the preceding lemma is useful provided that $m \ge n/2^{o(\sqrt{d})}$.]


\begin{proof}
  Treat the vertices of a hypercube $Q_d$ as binary strings and, for each $v\in V(Q_d)$ and $i\in\{0,\ldots,d-1\}$, let $v_i$ denote bit-$i$ of $v$.
  Let $\epsilon:=1/\sqrt{d}$ to be defined shortly.
  We say that $S$ is \emph{$i$-balanced} if $|\{v\in S:v_i=b\}|\ge(\tfrac{1-\epsilon}{2})|S|$ for each $b\in\{0,1\}$.  We say that $S$ is \emph{fully balanced} if $S$ is $i$-balanced for each $i\in\{0,\ldots,d-1\}$.
  Observe that $S$ is $i$-balanced if and only if $T$ is $i$-balanced, so $S$ is balanced if and only if $T$ is balanced.\footnote{This is because of the bijection that takes $x\in S$ onto $x':=n-x-1$ in $T$. Since $n$ is power of $2$, $x'$ is obtained by flipping every bit in $x$.}

  First we consider the case in which $S$ is fully balanced.\todo{Split this into a separate lemma.}
  Let $k\le d$ and let $B:=b_{d-1},\ldots,b_{d-k}$ be an arbitrary binary string of length $k$.  Let $S_B:=\{v\in S:v_{d-1},\ldots,v_{d-k}=b_{d-1},\ldots,b_{d-k}\}$.  Since $S$ is balanced,
  \[
     |S_B|\ge \left(\tfrac{1-\epsilon}{2}\right)^k m  \ge 1
  \]
  provided that
  \begin{align*}
     k
     & \le\frac{\log m}{\log(2/(1-\epsilon))} \\
     & \le \frac{\log m}{\log(2(1+\epsilon))} \le \frac{\log m}{1+2\epsilon\log e} \\
     & \le (1-4\epsilon\log e)\log m \\
     & \le \log m - 4\epsilon\log e\log n &\text{(for $\epsilon < BLAH$)} \\
     & = \log m - O(\sqrt{d}) \enspace .
  \end{align*}
  From this point on, we let $k:=\lfloor\log m - 4\epsilon\log e\log n\rfloor=\log m + O(\sqrt{d})$ and we set $r=d-k$.
  Now we have
  \[ d-k = \log n - k
         \ge \log n - \log m + O(\sqrt{d})
         = \log(n/m)+O(\sqrt{d}) \enspace .
  \]
  Since $S$ and $T$ are symmetric, the same argument implies that $T_B:=\{v\in T: v_{d-1},\ldots,v_{d-k}=b_{d-1},\ldots,b_{d-k}\}$ is non-empty.

  This implies that the subgraph $R_B$ of $R$ induced by $\{v\in V(Q_d):v_{d-1},\ldots,v_{d-k}=b_{d-1},\ldots,b_{d-k}\}\times V(P_r)$ contains at least one vertex $s_B\in S$ and at least one vertex $t_B\in T$.  The subgraph $R_B$ contains the direct product of $Q_{d-k}$ and $P_r$, so the diameter of $R_B$ is at most $r=d-k=\log(n/m)+O(\sqrt{d})$. Therefore, there is a length-$r$ path $P_B$ from $s_B$ to $t_B$ that remains entirely in $R_B$.  For two distinct $k$-bit strings $B$ and $B'$, $R_B$ and $R_{B'}$ are vertex-disjoint and therefore $P_B$ and $P_{B'}$ are vertex disjoint.  Furthermore, if $B< B'$, then $s_B< s_{B'}$ and $t_B < t_{B'}$. In this way, we obtain
  $2^k = m/2^{O(\sqrt{d})}$ paths that satisfy the requirements of the lemma.

  Observe that the number of paths obtained when $S$ is fully balanced is considerably greater than what the lemma requires. This fact will be used to reduce the case in which $S$ is not fully balanced to a smaller full balanced problem on a subgraph of $R$.

  Next we consider the case in which $S$ is not balanced.  First let us upper bound the number of indices $i$ for which $S$ is $i$-unbalanced.  Suppose that $S$ is $i$-unbalanced for each $i$ in some $t$-element set $I:=\{i_1,\ldots,i_\alpha\}$.  This implies that $S$ contains a subset $S'$ of size
  \[
    m':=|S'|\ge \left(\tfrac{1+\epsilon}{2}\right)^\alpha m
  \]
  that is contained in a hypercube isomorphic to $Q_{d-\alpha}$ having $n':=2^{d-\alpha}$ vertices.  Clearly, $n'\ge m'$, and a calculation like the one above implies that $\alpha\in O(\sqrt{d}\log(n/m))$.  Therefore,
  \[
    m'
      \ge \left(\tfrac{1+\epsilon}{2}\right)^\alpha m
      \ge \frac{m}{2^\alpha} \ge \frac{m}{(n/m)^{O(\sqrt{d})}}
  \]
  Now let $T':=\{n-v-1:v\in S'\}$.  For each vertex $s\in S'$, construct a path $P_s:=(s_0,p_0),\ldots,(s_\alpha,p_\alpha)$ that begins at $(s_0,p_0):=(s,p_0)$ and, for each $j\in\{1,\ldots,\alpha\}$ moves from $(s_{j-1},p_{j-1}$ to $(s_j,p_j)$ by flipping bit $i_j$ of $s_{j-1}$.  Observe that, for two distinct $s,s'\in S'$, $P_s$ and $P_{s'}$ are vertex-disjoint and, $s< s'$ if and only if $s_r < s'_r$.  Now observe that the sets $S'_\alpha:=\{s_\alpha:s\in S\}$ and $T'$ are each contained in a subgraph $R'$ of $R$ that contains a strong product of $Q_{d-\alpha}$ and a path $P_{r-\alpha}$ of length $r-\alpha$  Observe, further, that $n'/m' \le n/m$.  Finally, the sets $S'_\alpha$ and $T'$ are fully balanced with respect to $R'$, so that we can use the result for fully balanced sets to find a set paths that satisify conditions of the lemma, with respect to the subgraph $R'$.  For each such path $P'_s$ that begins at $s_\alpha\in S'$ and ends at $t\in T'$, concatenating the paths $P_s$ and $P'_s$ gives a path that begins at $s\in S$ and ends at $t\in T$.  This gives a collection of paths that satisfies requirements of the lemma, with respect to $R$, and that has size at least
  \[
      \frac{m'}{2^{O(\sqrt{d})}} \ge \frac{m}{(2n/m)^{O(\sqrt{d})}}
      \enspace ,
  \]
  as required.
\end{proof}




% Let $c$ be the constant in \cref{block_erdos_szekeres}, rounded up to the next integer power of $2$ (so $c:=2^{\lceil\log_2 c'\rceil}$ where $c'$ is denoted by $c$ in the statement of \cref{block_erdos_szekeres}).  Let $r:=2^d$ for some positive integer $d$ and let $n:=cr$ where $c$ is the constant given by \cref{block_erdos_szekeres}.  Now we construct the following graph $G$ from the following pieces:
% \begin{enumerate}
%     \item $G$ contains the set of $n$ length-$2$ paths described by  \cref{rainbow_alternative_paths} for $\ell:=2$;
%     \item $G$ contains the graph $R(d+\log_2 c,c)$ described in \cref{routing};
%     \item For each $k\in\{0,\ldots,cr-1\}$ and each $i\in\{1,\ldots,r\}$, $G$ contains the edge with endpoints $(k,p_0)$ and $s_{kr+i}$; and
%     \item For each $k\in\{0,\ldots,cr-1\}$ and each $i\in\{1,\ldots,r\}$, $G$ contains the edge with endpoints $(k,p_r)$ and $t_{kr+i}$; and
% \end{enumerate}

\bibliographystyle{plainurlnat}
\bibliography{qn-vs-sn}
\end{document}

\section{Old Stuff}

An old result of \citet[Theorem 8]{dujmovic.wood:stacks} shows that queue number is (polynomially) bounded by by stack number if and only if bipartite 3-stack graphs have bounded queue number.  Even forgetting the bipartite condition, this means we can restrict ourselves to graphs made up of three outerplanar graphs $G_1$, $G_2$, and $G_3$ having a common outer face $v_1,\ldots,v_n$.

If we're trying to show that queue number is not bounded by stack number then we will need all three of these triangulations.  Why? Because two triangulations of $v_1,\ldots,v_n$ form a (Hamiltonian) planar graph.  We already know that any planar graph has queue number at most $49$.

I conjecture that the expected queue number of the random (multi)graph $G$ obtained by taking each of $G_1,\ldots,G_3$ to be a random triangulation of $v_1,\ldots,v_n$ is unbounded.  Here, a \emph{random triangulation} of a $n$-vertex cycle $C$ is the outerplanar graph with outer face $C$ and whose weak dual is a uniformly random binary search tree with $n-2$ nodes.  [There is a bijection between these triangulations and full binary trees with $n-1$ leaves, so the number of such triangulations is the $(n-2)$-th Catalan number $C_{n-2}$.]

Even if this turns out to be false or if the result can be proven with a deterministic construction, I think this model of random graph is interesting and worth studying.  In general, we could define the ``random stack-number-$k$ graph'' $R_{n,k}$ obtained by taking the union of $k$ random triangulations of the cycle $v_1,\ldots,v_n$ and ask questions about it.
\begin{compactenum}
    \item What is the expected maximum degree of $R_{n,k}$?
    \item What is the expected diameter of $R_{n,k}$?
    \item What is the expected treewidth of $R_{n,k}$?
    \item What is the expected queue number of $R_{n,k}$?
\end{compactenum}

Some conjectures about the answers to these questions:

\begin{enumerate}
    \item For $k=1$, the answers are $\Theta(\log n)$, $\Theta(\sqrt{n})$, $2$, and $O(1)$.  (The last two are facts, not conjectures)

    \item For $k=2$, the answers are $\Theta(\log n)$, $\Theta(\sqrt{n})$, $\Theta(\sqrt{n})$, and $O(1)$, respectively.  (Only the last one is a fact, the rest are conjectures.)

    \item For $k=3$ the answers are $\Theta(\log n)$, $\Theta(n^{1/3})$, $\Theta(n^{2/3})$ and $\Omega(1)$. (All conjectures.)
\end{enumerate}

The question about maximum-degree is really just about uniformly random binary trees.  It asks what is the longest path in such a tree that repeatedly goes from a node to its right child.  It feels like we can use symmetry to treat this the same as a random walk in an arbitrary binary tree.  In an arbitrary binary tree, the probability that a random walk takes more than $\log n+k$ steps is at most $2^{-k}$.  I guess this could easily be made precise and settles the first question for any constant $k$.

Here's a very rough intuition about the diameter (for $k=1$).  Since the height of the random tree $T$ that defines the triangulation $R_1$ is $\Theta(\sqrt{n})$, most nodes of $T$ have a child that is the root of a subtree of size $O(\sqrt{n})$.  So most of the time, the triangle $v_1v_iv_n$ of $R_1$ has $\max\{i, n-i\}\in O(\sqrt{n})$, say $i\in O(\sqrt{n})$.  Then the node furtest from $v_1$ is at distance least one greater than the node furthest from $\{v_i,v_n\}$ on the subgraph induced by $v_i,\ldots,v_n$.  This is a subgraph of size $n-O(\sqrt{n})$.  I guess this argument is basically showing that there exists a cutset of size $2$ that separates a vertex from a part of the graph of size $n-\sqrt{n}$.

Here's another approach for the diameter in the case $k=1$.  With high probability, the tree $T$ contains a root-to-leaf path $P$ of length $\Omega(\sqrt{n})$.  With high probablity, $P$ contains $\Omega(\sqrt{n})$ \emph{alternations}; subpaths of the form $xyz$ where $y$ is the right child of $x$ and $z$ is the left child of $y$ (or \emph{vice-versa} with the roles of left and right reversed).  This means there exists a vertex $v$ of $R_1$ such that $\{v_1,v_n\}$ is separated from $v$ by a sequence $\{a_1,b_1\},\ldots,\{a_k,b_k\}$ of disjoint $2$-vertex cutsets, where $k\in\Omega(\sqrt{n})$.  So every path from $v_1$ to $v$ must contain at least one of $a_i$ or $b_i$ for each $i\in\{1,\ldots,k\}$.  Therefore, $\diam(G)\ge k+1\in \Omega(\sqrt{n})$.

Both of the preceding arguments seems to break down immediately, even for $k=2$.  Note that understanding diameter is a prerequisite for understanding treewidth since (at least for $k=2$) $\tw(R_2) \in O(\diam(R_2))$ since $R_2$ is planar.
% In fact, upon reflection, I think that $\diam(R_2)\in O(\log n)$.


\subsection{Another Candidate}

Another candidate graph is the following: $G_1\cup G_2$ form an $n\times n$ grid.  (This has a realization as a 2-page graph where $v_1,\ldots,v_n$ is the snake-like path through the rows of the grid, $G_1$ contains the vertical grid edges from row $i$ to row $i+1$ for odd $i$, and $G_2$ contains the remaining vertical grid edges.)  The graph $G_3$ is the random graph $R_1$ described above.

First we'd like to see if the treewidth of this graph is large.  We might try to do this as follows:
\begin{compactenum}
    \item Fix a separation $(A,B)$ of $G_1\cup G_2$ of order $O(\sqrt{n})$.
    \item This separation divides $v_1,\ldots,v_n$ into $O(sqrt(n))$ intervals.  Some of these are in $A\setminus B$ and some of these are in $B\setminus A$.
    \item The
\end{compactenum}


\subsection{Another Candidate: The $3$-Ary Hypertwist}

Let $N:=3^{d-1}$ for some integer $d\ge 1$.  Given a sequence $V:=x_1,\ldots,x_{N},y_1,\ldots,y_N,z_1,\ldots,z_N$ of $3^d$ distinct vertices we define the \emph{$3$-ary hypertwist} $H_V:=H$ over $V$ as follows (see \cref{hypertwist}):
\begin{compactenum}
    \item $V(H_V):=\{V\}$;
    \item $E(H_V)$ contains $\bigcup_{i=1}^N\{x_iy_i, y_iz_i, x_iz_{n-i+1}\}$; and
    \item If $d \ge 2$ then $H_d$ contains $H_{x_1,\ldots,x_N}$, $H_{y_1,\ldots,y_N}$ and $H_{z_1,\ldots,z_N}$.
\end{compactenum}

\begin{figure}
    \begin{center}
        \includegraphics{figs/hypertwist-3}
    \end{center}
    \caption{The graph $H_3$. In this drawing the vertices appear in the order $x_1,\ldots,X_N,y_N,\ldots,y_1,z_1,\ldots,z_N$.}
    \label{hypertwist}
\end{figure}

We call $H_V$ a \emph{hypertwist of dimension $d$} and we denote it by $H_d$. For convenience, $H_0$ is the graph consisting of a single vertex. The following is easily proven by induction on $d$ (and \cref{hypertwist} illustrates the ordering used in the stack layout):

\begin{lem}\label{hypertwist_sn}
    $\sn(H_d) \le 3d-2$.
\end{lem}

If we can prove the following conjecture then we are done:

\begin{conj}\label{hypertwist_qn_conjecture}
    There exists an integer $d_0$ and real $\alpha >0$ such that $\qn(H_d)\ge 3^{\alpha d}$ for all $d\ge d_0$.
\end{conj}

Explanation:  A lemma of \citet{dujmovic.wood:stacks} states that, if queue-number is bounded by stack-number, then queue-number is bounded by a polynomial function of stack number. More precisely, if there exists a function $f:\N\to\N$ such that $\qn(G)\le f(\sn(G))$ for all graphs $G$ then there exists a constant $c$ such that $\qn(G)\in O((\sn(G))^c)$ for all graphs $G$.  By \cref{hypertwist_sn}, $\sn(H_d)=O(d)$, but \cref{hypertwist_qn_conjecture} asserts that $\qn(G)\ge 3^{\Omega(d)}$.  We are done because $\qn(H_d)\ge 3^{\Omega(d)} \not\in O(d^c)=\sn(H_d)$ for any constant $c$.


This graph behaves a lot like a $3$-ary hypercube.

\begin{compactenum}
    \item Each vertex of $H_d$ has degree $2d$.
    \item $H_d$ has diameter $d$ (use the coordinate-based routing algorithm, like in a hypercube).
    \item I think (but would have to prove) that any $m$-vertex subgraph of $H_d$ has average degree at most $2\log_3 m$.  (Heath, Leighton, and Rosenberg proved this for the $3$-ary hypercube.)
\end{compactenum}


Let's start with a basic and well-known lemma:

\begin{lem}\label{rainbow_alternative}
    Let $M$ be a perfect matching with edge set $E(M):=\{a_ib_i:i\in\{1,\ldots,k\}\}$ and let $<$ be a total order on $V(M)$.  Then $M$ contains a rainbow of size at least $q$ or there exists $I\subset\{1,\ldots,k\}$, $|I|\ge k/q$ such that $a_i < a_j$ if and only if $b_i< b_j$ for each $i,j\in I$.
\end{lem}

\begin{proof}
    Apply Dilworth's Theorem to the partial order $(\prec,\{1,\ldots,k\})$ in which $i\prec j$ if and only if $a_i<a_j$ and $b_i < b_j$.  Any antichain in $\prec$ is a rainbow and any chain in $\prec$ is the set $I$ in the second alternative.
\end{proof}


\begin{lem}\label{x-to-z}
    Let $(<,\varphi)$ be a $<q$-queue layout of $H_d$. Then, for any $I\subset\{1,\ldots,N\}$, there exists $I'\subseteq I$, $|I'|\ge|I|/q^2$ such that, for each $i,j\in I$, $x_i<y_j$ if and only if $y_i < y_j$ and $z_i < z_j$.
\end{lem}

\begin{proof}
    Since $(<,\varphi)$ is a $<q$-queue layout, $H_d$ does not contain any rainbow of size $q$ with respect to $<$.  Apply \cref{rainbow_alternative} twice, once using the matching $\{x_iy_i: i\in I\}$ to obtain a set $I_1$ of size at least $|I|/q$ and a second time to the matching $\{y_i z_i: i\in I_1\}$ to obtain the set $I'$ of size at least $|I|/q^2$.
\end{proof}

\begin{lem}
    Let $(<,\varphi)$ be a $<q$-queue layout of $H_d$. Then there exists $I\subset\{1,\ldots,N\}$ with the following properties:
    \begin{compactenum}
        \item $|I'|\ge N/q^3$;
        \item for each $i\in I$, $\overline\imath\in I$;
        \item for each distinct $i,j\in \{x\in I:x < N/2\}$, $x_i < x_j$ if and only if $x_{\overline\imath}< x_{\overline\jmath}$; and
        \item $i,j\in I$, $x_i<y_j$ if and only if $y_i < y_j$ and $z_i < z_j$.
    \end{compactenum}
\end{lem}

\begin{proof}
    First apply \cref{rainbow_alternative} to the matching $\{x_ix_{\overline\imath}: i\in\{1,\ldots,N\}\}$ then apply \cref{x-to-z} to the resulting set.
\end{proof}

% The lemmma stated in this comment is false.
% For $I\subseteq\{1,\ldots,N\}$, let $x_I:=\{x_i:i\in I\}$, define $y_I$ and $z_I$ similarly, and define $G_I:=G[x_I\cup y_I\cup z_I]$.  We say that such a set $I$ is \emph{symmetric} if $\overline{v}\in V(G_I)$ for each $v\in V(G_I)$.
%
% \begin{lem}
%     If there exists a $k$-element symmetric set $I\subset\{1,\ldots,N\}$ such that $x_I\cup y_I$ is separated from $z_I$ with respect to $<$, then $H_d$ contains a rainbow of size $k^{c}$.
% \end{lem}
%
% \begin{proof}
%     Here are the steps in the proof:
%     \begin{compactenum}
%         \item Use pigeonhole to find $I_1\subseteq I$ of size at lest $k/2$ such that $x_i< y_i$ for each $i\in I_1$.
%
%         \item Use Dilworth's Theorem and the existence of each edge $x_ix_{\overline\imath}$ to find $I_2\subseteq I_1$ such that $x_{\{i\in I_2:i\le N/2\}}$ and $x_{\{i\in I_2:i\ge N/2\}}$ have the same order (where we match $x_i$ with $x_{\overline{\imath}}$).
%
%         \item Use Dilworth and the existence of the edge $x_iy_i$ to find $I_3\subseteq I_2$ such that $x_{I_2}$ and $y_{I_2}$ have the same ordering (where we match $x_i$ with $y_i$).
%
%         % \item Use Dilworth and the existence of the edge $z_iz_{\overline\imath}$ to find $I_4\subseteq I_3$ such that $z_{\{i\in I_3:i\le N/2\}}$ and $z_{\{i\in I_3:i\ge N/2\}}$ have the same order (where we match $z_i$ with $z_{\overline{\imath}}$).
%     \end{compactenum}
%     Now we're done.  Let $I_4':=\{i\in I_4:i\le N/2\}$ and let $\overline{I}_4':= I_4\setminus I_4'$.
%     If $y_{I_4'}$ and $z_{I_4'}$ don't contain a big rainbow then $y_{I_4}$ and $z_{I_4'}$ contain a big twist.  By Step~2 above, $x_{I_4'}$ and $y_{I_4'}$ have the same order.  By Step~1 above, $x_{I_4'}$ and $y_{\overline{I}_4'}$ have the same order.  This implies that the edge set $\{x_{\overline{\imath}}z_i:i\in I_4'\}$ form a big rainbow.
% \end{proof}

\begin{lem}
  For any $q$-queue layout $(<,\varphi)$  of $H_d$, there exists $I\subseteq\{1,\ldots,N/2\}$ and an integer $s\in\{1,\ldots,6\}$ such that:
  \begin{compactenum}[(i)]
    \item $|I|\ge N/q^{O(1)}-f(q)$, for some fixed $f:\N\to\N$;

    \item for each $i,j,\in\{1,\ldots,N/2\}$, the permutation of $R_i:=x_i,x_{\overline{\imath}},y_i,y_{\overline{\imath}},z_i,z_{\overline{\imath}}$ defined by $<$ is the same as the permutation of $R_j:=x_j,x_{\overline{\jmath}},y_j,y_{\overline{\jmath}},z_j,z_{\overline{\jmath}}$ defined by $<$; and

    \item for each distinct $i,j\in\{1,\ldots,N/2\}$, $R_i$ is an $s'$-shift of $R_j$ for some $s'\in\{-s,s\}$.
  \end{compactenum}
\end{lem}

\begin{proof}[Proof Sketch]
  First classify $i\in\{1,\ldots,N/2\}$ based on the permutation of $R_i$ (there are only $6!$) and then on the edge-colouring of (a spanning tree of) $H_d[R_i]$ (there are only $q^5$).  Taking the biggest class gives us a set $I_0$ of size at least $N/(2\cdot 6!\cdot q^5)$ that satifies (ii).  Now, classify each pair $i,j\in I_0$ based on how $R_i$ and $R_j$ interleave.  There are no more than $2^{12}$ categories and $6$ of them are $s$-shifts.  Suppose that one of the categories, $C$, that is not an $s$-shift has size greater than $f(q)$ for some (very fast growing function $f$).  Then, by Ramsey's Theorem there exists $J\subseteq I_0$ of size at least $q^c$ such that each pair in $J$ is in category $C$. Now argue that results in a rainbow of size greater than $q$.

  Conclude that these ``non-shift'' categories have total size at most $2^{12}f(q)$, so one of the $6$ shift categories has size at least $(|I_0|-2^{12}f(q))/6$.
\end{proof}



\begin{lem}
    If there exists a $k$-element symmetric set $I\subset\{1,\ldots,N\}$ such that $x_I\cup z_I$ is separated from $y_I$ with respect to $<$, then $H_d$ contains a rainbow of size $k^{1/4}/sqrt{2}$.
\end{lem}

\begin{proof}
    Similar to the previous proof, except that
\end{proof}


\begin{obs}\label{cant_separate2}
    If there exists a set $I\subseteq\{x_{N/2+1},\ldots,x_{N},y_{1},y_{N/2}\}$ such that $I$ and $\overline{I}$ are separated with respected to $<$, then $G$ contains a rainbow of size at least $\sqrt{I}$.
\end{obs}

\begin{proof}
The vertices in $I$ and $\overline{I}$ form a twist and a rainbow\todo{Be more precise}. \ldots
\end{proof}

\begin{obs}\label{cant_separate3}
    If there exists a set $I$ such that $x_I$, $y_I$ and $z_I$ are separated with respect to $<$, then $H_d$ contains a rainbow of size at least $\sqrt[4]{|I|}$.
\end{obs}

\begin{proof}
    By Dilworth's Theorem, if $G$ does not contain a rainbow of size $\sqrt{|I|}$ then there is a subset $I'\subseteq I$ of size at least $\sqrt{|I|}$ such that $x_{I'}$ and $y_{I'}$ form a twist.  Another application of Dilwerth's Theorem then implies that there exits $I''$ of size at least $\sqrt[4]{|I|}$ such that $y_{I''}$ and  $z_{I''}$ form a twist.  But then $x_{I''}$ and $z_{I''}$ form a rainbow.
\end{proof}


\cref{cant_separate} implies that, in any efficient queue layout of $H_d$, the vertex sets of at least two of $G_x$, $G_y$, and $G_z$ must be highly interleaved.  What happens if we just try to interleave $G_x$ and $G_y$ (and leave $G_z$ separated)?  Actually, that also implies a large rainbow.  Use Dilworth to show that (because $H_d$ contains the edge $x_{i}y_i$ is in $H_d$ for each $i\in I$) there exists a subset $I'$ of $I$ so that the ordering of $x_{I'}$ and $y_{I'}$ is the same.  Then apply Dilworth again.

What happens if we try to interleave $G_x$ and $G_z$ but leave $G_y$ separated?  The same problem:  We find $I'$ such that $x_{I'}$ and $z_{I'}$ are reversed.  Therefore one of them forms a big rainbow with $y_{I'}$.  So, ultimately, it must be that $G_x$, $G_y$, and $G_z$ are all highly interleaved.


% \subsection{(Failed) Attempt to Layout $H_d$}
%
% For any $i\in\{1,\ldots,N\}$, let $\overline{\imath}:=N-i+1$. For $v:=x_i$, let $\overline{v}:=z_{\overline\imath}$. For $v:=y_i$, let $\overline{v}:=y_{\overline\imath}$.  We will prove, by induction on $d$ that $H_d$ has an $cd$-queue layout in which $S:=\{v-\overline{v}:v\in V(H_d)\}$  has size $d^{O(1)}$.  The base case $d=1$ is trivial: $H_1$ consists of three copies $H_{x_1},H_{y_1},H_{z_1}$ forming a $3$-cycle. Use the vertex ordering $x_1<y_1<z_1$ and one queue.
%
% For $d>1$, recursively compute a $c(d-1)$-queue layout of $H_{y_1,\ldots,y_N}$.  Use the same layout for $H_{x_1,\ldots,x_N}$ and for $H_{z_1,\ldots,z_N}$ and, in the ordering of $H_V$, use the order $V(H_{x_1,\ldots,x_N}) < V(H_{y_1,\ldots,y_N}) < V(H_{z_1,\ldots,z_N})$.
%
% First we have to show that this layout requires at most $cd$ queues. By induction,  the layouts of the three recursive subgraphs use $c(d-1)$ queues.  The edges that are not contained in one of the three recursive subgraphs can be decomposed into $\lfloor N/6\rfloor$ $6$-cycles of the form $x_i,y_i,z_i,x_{\overline\imath},y_{\overline{\imath}},z_{\overline{\imath}}$ and one $3$-cycle $x_{\ceil{N/2}},y_{\ceil{N/2}},z_{\ceil{N/2}}$.  In the ordering described above, the edges of the $3$-cycle all have length $N$ and four of the edges of each $6$-cycle all have length $n$.  The two other edges of the $6$-cycle have length $2N+y_{i}-y_{\overline{\imath}}$ and $2N-y_{i}+y_{\overline{\imath}}$.\todo{Abusing notation a little here.}
%
%
% STOP: This will fail because we eventually get a recurrence for $|S|$ that looks like $s_d \le 1 + 2s_{d-1}$.  The one counts edges of length $N$. The first $s_{d-1}$ counts the edge lengths that appear in $H_y$.  The second $s_{d-1}$ counts the new edge lengths of the form $2N+y_i-y_{\overline\imath}$.  This resolves to $c^d$ for some $c\ge 2$.
%
% Here's an even easier reason why this can't work: Split the vertices of $G_3$ into two groups: the first half $z_1,\ldots,z_{N/2}$ and the second half  $z_{N/2+1},\ldots,z_N$.  The first half is connected to $x_{N/2}+1,\ldots,x_{N}$ and the second half is connected to $x_{1},\ldots,x_{N/2}$.  All of these edges overlap so they contain a rainbow a twist of size at least $\Omega(\sqrt{n})$.  But a twist in the first set is a rainbow in the second set, so we definitely get a rainbow of size at least $\sqrt{n}$.
%
%
% LESSON 1: To show that $\qn(H_d)\ge 3^{\Omega(d)}$ we could first try to show that the number of edge lengths used in a queue layout of $H_d$ is at least $3^{\Omega(d)}$.    Note that this isn't true for the standard ternary $d$-cube.  There the queue layout only uses edges of length $3^i$ and $2\cdot 3^i$ for $i\in\{0,\ldots,d-1\}$. This turns out not to be so useful (see below).
%
% Lesson 2: The preceding argument shows that we have to interleave $V(G_x)$ and $V(G_z)$ or we have to use different layouts for $G_x$ and $G_z$.  The same goes for $G_y$ and $G_z$.
%
% \begin{compactenum}
%     \item If we use the same (or a mirrored) layout of $G_x$ and $G_z$ and interleave $G_x$ and $G_z$ in the obvious way, so that $x_1<z_1<\cdots<x_N<z_N$ then we immediately get a rainbow.  If we try to reverse $G_z$ so that $x_1<z_N<\cdots<x_N<z_1$ then we're ok, but we end up being constrained to using a \emph{symmetric} layout (where the symmetry is around $y_{N/2}$). This is impossible because interleaving $G_x$ and $G_z$ implies that the layout is not symmetric.
%
%     \item If we try to separate $G_x$ and $G_z$
% \end{compactenum}
%
% % WAIT: We need that the distance $y_i-y_{\overline{\imath}}$ is fixed, independent of $i$ (or comes from a set of size $d^{O(1)}$).  If I really want that difference to be fixed, then there are only $O(N)$ possible orderings. Indeed, once we fix the ordering of $y_1,\ldots,y_{m-1}$ the ordering of $y_{m+1},\ldots,y_N$ is also fixed, and these two sets must perfectly interleave where they overlap.  If we try to put this into the inductive hypothesis, then this breaks everything because $|y_i-y_{\overline\imath}| < N$ but $|x_i-\overline{z_{\imath}}|\ge N$.  Indeed, this completely rules out a recursive layout in which $H_x<H_y<H_z$.
% %
% % Can we make it so that $v-\overline{v}$ falls into a set of size $d^{O(1)}$?  No: If we try to set up a recurrence where $s_d$ tries to count
%
% % we then have to show that $x_i$ and This breaks everything, because it says that $x_i$ and $z_{\not}
% %
% %
% %
% %
% % Now, inductively find a layout of $H_{x_1,\ldots,x_N}$ using $c(d-1)$ queues.  Use the same layout for $H_{y_1,\ldots,y_N}$ and $H_{z_1,\ldots,z_N}$.  Put these three layouts in order.  Now, each of the $6$-cycles described above has $4$ edges of length $N$
%
%
% \begin{figure}
%     \begin{center}
%         \includegraphics{figs/hypertwist_qn-4}
%     \end{center}
%     \caption{The ordering used in an efficient queue layout of $H_3$.}
%     \label{hypertwist_qn}
% \end{figure}
%
%
% \subsection{A New Edge-Length-Based Parameter}
%
% Let $M$ be a $2k$-vertex perfect matching with edge set $\{(a_i,b_i):i\in\{1,\ldots,k\}\}$ and let $<$ be a total order of $V(M)$ such that $a_i < b_j$ for all $i,j\in\{1,\ldots,k\}$.  The \emph{length} of an edge $vw$ in $M$ is $\ell_<(vw):=1+|\{x\in V(M): v < x< w\}|$.  Define the \emph{length set} $L(M):=\{\ell(vw):vw\in E(M)$.
%
% Clearly, if $M$ contains a rainbow (with respect to $<$) of size $r$, then $|L(M)|\ge r$.  I believe there is also an inequality in the other direction:
%
% \begin{conj}
%     There exists $a,c >0$ such that, if $|L(M)|\ge r$ then $M$ contains a rainbow of size at least $ar^{c}$.
% \end{conj}
%
% The preceding conjecture is false.  Let $k$ be an even integer and use the order $a_1<\cdots<a_k$ and $b_1<b_{k/2+1}<b_2<b_{k/2+2}<\cdots< b_{k-1}<b_k$.  Then the largest rainbow has size $2$ since $a_ib_i$ and $a_jb_j$ don't nest unless $i \le k/2$ and $j\ge k/2$.  Furthermore, for $i\le k/2$, $\ell(i):=\ell(a_ib_i)=k-i+(2i-1)=k+i-1$ is an increasing function of $i$, so $|L(M)|\ge k/2$.
%
% Actually for $i > k/2$, $\ell(i):=\ell(a_ib_i)=k-i+2(i-k/2)=i$. This function takes on all values in the set $\{f(k/2+1)\ldots,f(k)\}=\{k/2+1,\ldots,k\}$. So, actually, $|L(M)|=k-1$.  (If we use an odd $k$, then we can get $|L(M)|=k$.)
%
% This gives an alternative way to do bipartite matchings that has lots of different edge lengths and small rainbows.  Maybe this can be used to find a queue layout of $H_d$?
%

\section{A shortcut}

Let $X:=\{x_0,\ldots,x_{n-1}\}$, $Y:=\{y_0,\ldots,y_{n-1}\}$ and $Z:=\{z_0,\ldots,z_{n-1}\}$.  Let $<$ be a total order on $X\cup Y\cup Z$ where $X<Y<Z$ and, for each $0\le i<j< n$, $x_i<x_j$, $y_i<y_j$ and $z_i<z_j$.
Take a tripartite graph $G:=(X,Y,Z,E)$ such that $G$ has an $s$-stack layout $(<,\varphi)$ and each of $G_{XY}:=G[X\cup Y]$, $G_{YZ}:=G[Y\cup Z]$ and $G_{XZ}:=G[X\cup Z]$ are bipartite 2-sided $\delta$-expanders.

A result of Bourgain and Yehudahoff shows that such a $G$ exists width $s\in O(1)$.  That result is hard to understand. An easier construction, due to Alon and Roichman shows that if we just pick $k:=\lceil c(\delta)\log n\rceil$ random values $\ell_1,\ldots,\ell_k\in\{0,\ldots,n-1\}$, then the graph $G_{XY}$ with edge set $E(G_{XY})=\{(x_i,y_{(i+\ell_j)\bmod n}):i\in\{0,\ldots,n-1\},j\in\{1,\ldots,k\}\}$ is a $\delta$-expander.  It's easy to see that this ``shift-graph'' has a stack layout $(<,\varphi)$ using $s:=2k= O(\log n)$ stacks.  This will be good enough if we can prove that the queue number of $G$ is at least $n^\alpha$ for some fixed $\alpha>0$.  (The remark on Page~8 of the Alon-Roichman paper even considers the cyclic group $Z_n$, which is what we're using here.)

The idea now is to show that any $q$-queue layout $(<',\varphi')$ of $G_{XY}$ is quite restricted.  Basically, that $X$ can be separated into $t:=O(q)$ groups $X_1,\ldots,X_t$ such that $X_1<'\cdots<'X_t$ and $<'$ essentially agrees with $<$ or $<'$ essentially reverses $<$ within each group $X_i$ (with the same decision for each $X_i$).  This would be good enough, since we can then argue as follows:
\begin{enumerate}
   \item Assume, without loss of generality that $<'$ essentially agrees with $<$.
   \item To avoid a large rainbow in $G_{XY}$, $<'$ must essentially reverse $<$ on $Y$.
   \item To avoid a large rainbow in $G_{XY}$, $<'$ must essentially agree with $<$ on $Z$.
   \item But now $<'$ essentially agrees with $<$ or $X$ and $Z$, which forces a large rainbow in $G_{XZ}$.
\end{enumerate}
\bibliographystyle{plainurlnat}
\bibliography{qn-vs-sn}


\section{Starting Fresh}

Let $A:=\{a_1,\ldots,a_n\}$ and $B:=\{b_1,\ldots,b\}$ be two disjoint sets and let $<$ be a total order over $A\cup B$ such that $a_1<\cdots<a_n<b_1\cdots<b_n$.  A \emph{$2$-sided $d$-monotone $(A,B)$-$(1+\epsilon)$-expander} is a bipartite graph $G$ with vertex set $V(G):=A\cup B$ such that
\begin{compactenum}[(P1)]
    \item $G$ has no $(d+1)$-rainbow with respect to $<$; and
    \item For any $S\subset A$, $|N_G(S)\cap B|\ge\min\{n,(1+\epsilon)|S|\}$.
\end{compactenum}

\begin{thm}[Bourgain]\label{bourgain}
    For any $\epsilon>0$, there exists an integer $d:=d(\epsilon)$ such that for any $n\in\N$ there exists a $2$-sided $d$-monotone $(A,B)$-$(1+\epsilon)$-expander.
\end{thm}


\begin{lem}
    Let $G$ be a $2$-sided $d$-monotone $(A,B)$-$c$-expander given by \cref{bourgain} and let $<$ be a $q$-queue ordering of $G$. Then there exists a partition $\mathcal{P}$ of $\{1,\ldots,n\}$ such that
    \begin{compactenum}[(i)]
        \item for each $P\in\mathcal{P}$ and each $i,j\in P$, $i<j$ if and only if $a_i<a_j$; or
        \item for each $P\in\mathcal{P}$ and each $i,j\in P$, $i<j$ if and only if $a_i>a_j$.
    \end{compactenum}
\end{lem}


\end{document}
